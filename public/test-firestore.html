<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flowivity Task Viewer</title>
</head>
<body>
  <h1>ðŸ“‹ Smart Planner Task Viewer</h1>
  <div id="task"></div>

  <script type="module">
    // Core Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app-check.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    // Restricted Firebase config (already locked by domain/API)
    const firebaseConfig = {
      apiKey: "AIzaSyDxejXPOwcITSFhLzhkXNVmC5C68qNeGGE",
      authDomain: "flowivity-efd2f.firebaseapp.com",
      projectId: "flowivity-efd2f",
      storageBucket: "flowivity-efd2f.appspot.com",
      messagingSenderId: "725140207431",
      appId: "1:725140207431:web:eea21c7aa7f201a6063e62",
      measurementId: "G-GD8DR7NRZ9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Initialize App Check with reCAPTCHA v3 (public Site Key)
    initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider("6Le8b08rAAAAAA4zp56M3Z3GWD_n-GrNBP_c41l3"),
      isTokenAutoRefreshEnabled: true
    });

    // Get Firestore instance
    const db = getFirestore(app);

    // Fetch and render tasks
    const taskListDiv = document.getElementById("task");
    async function fetchTasksForUser() {
      const tasksQuery = query(
        collection(db, "planner_tasks"),
        where("userId", "==", "test_user_001")
      );
      const querySnapshot = await getDocs(tasksQuery);

      if (querySnapshot.empty) {
        taskListDiv.innerHTML = "<p>No tasks found for this user.</p>";
        return;
      }

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        taskListDiv.innerHTML += `
          <div style="margin-bottom: 1rem;">
            <p><strong>Task:</strong> ${data.task || "No title"}</p>
            <p><strong>Category:</strong> ${data.category || "N/A"}</p>
            <p><strong>Status:</strong> ${data.status || "N/A"}</p>
            <p><strong>Duration:</strong> ${data.duration || "N/A"} minutes</p>
            <p><strong>Timestamp:</strong> ${data.timestamp 
              ? new Date(data.timestamp.seconds * 1000).toLocaleString() 
              : "N/A"}</p>
            <hr />
          </div>
        `;
      });
    }
    fetchTasksForUser();
  </script>
</body>
</html>
